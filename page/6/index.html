<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"sjq597.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.18.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="数据开发工程师的成长历程">
<meta property="og:type" content="website">
<meta property="og:title" content="LittleQ">
<meta property="og:url" content="http://sjq597.github.io/page/6/index.html">
<meta property="og:site_name" content="LittleQ">
<meta property="og:description" content="数据开发工程师的成长历程">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="LittleQ">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://sjq597.github.io/page/6/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/6/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LittleQ</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">LittleQ</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">爱好：写代码</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">LittleQ</p>
  <div class="site-description" itemprop="description">数据开发工程师的成长历程</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">145</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://sjq597.github.io/2016/06/19/CentOS-%E5%AE%89%E8%A3%85Anaconda2-4-0-0-Linux-x86-64-sh%E6%8A%A5%E9%94%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LittleQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LittleQ">
      <meta itemprop="description" content="数据开发工程师的成长历程">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LittleQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/06/19/CentOS-%E5%AE%89%E8%A3%85Anaconda2-4-0-0-Linux-x86-64-sh%E6%8A%A5%E9%94%99/" class="post-title-link" itemprop="url">CentOS 安装Anaconda2-4.0.0-Linux-x86_64.sh报错</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-06-19 19:21:47" itemprop="dateCreated datePublished" datetime="2016-06-19T19:21:47+08:00">2016-06-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-07 14:54:54" itemprop="dateModified" datetime="2023-10-07T14:54:54+08:00">2023-10-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/" itemprop="url" rel="index"><span itemprop="name">开发环境</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>264</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>前阵子想给服务器都装上Python的全家桶，结果怎么也装不上,开始安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash Anaconda2-4.0.0-Linux-x86_64.sh</span><br></pre></td></tr></table></figure>
<p>但是装不了，一直报错:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir: cannot create directory `/home/q/anaconda2&#x27;: Permission denied</span><br><span class="line">ERROR: Could not create directory: /home/q/anaconda2</span><br></pre></td></tr></table></figure>
<p>网上查了之后发现很多人都碰到这个问题,后来大家都建议这么安装:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo bash Anaconda2-4.0.0-Linux-x86_64.sh</span><br></pre></td></tr></table></figure>
<p>结果报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Sorry, user xxx is not allowed to execute &#x27;/bin/bash Anaconda2-4.0.0-Linux-x86_64.sh&#x27; as root on xxxx.</span><br></pre></td></tr></table></figure>
<p>我去，简直无解了，没权限执行这个命令，普通的命令又装不了，结果折腾了好久也没办法，后来通过求助之后才发现，原来给这个包附个权限就可以执行了，原来如此,说干就干:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod 777 Anaconda2-4.0.0-Linux-x86_64.sh</span><br><span class="line">sudo ./Anaconda2-4.0.0-Linux-x86_64.sh</span><br></pre></td></tr></table></figure>
<p>后面一路畅通，搞定。</p>
<p>**Tips:**如果想用这个代替默认的环境变量，有些包这里又没有，假设你的安装目录为<code>/home/usr/anaconda2</code>,那么你可以这么装:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /home/usr/anaconda2/bin/pip install &lt;module_name&gt;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://sjq597.github.io/2016/06/18/Python-%E5%A4%9A%E7%BA%BF%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LittleQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LittleQ">
      <meta itemprop="description" content="数据开发工程师的成长历程">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LittleQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/06/18/Python-%E5%A4%9A%E7%BA%BF%E7%A8%8B/" class="post-title-link" itemprop="url">Python 多线程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-06-18 19:23:09" itemprop="dateCreated datePublished" datetime="2016-06-18T19:23:09+08:00">2016-06-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-07 14:54:54" itemprop="dateModified" datetime="2023-10-07T14:54:54+08:00">2023-10-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Python笔记</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>10 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="全局解释器锁"><a href="#全局解释器锁" class="headerlink" title="全局解释器锁"></a>全局解释器锁</h3><p>谈到Python多线程,不得不先说一下全局解释器锁(GIL),Python代码的执行由Python虚拟机(也叫解释器主循环)来控制,虽然有多个进程,但是某一个时刻只会有一个线程在执行,对Python虚拟机的访问由全局解释器锁(global interpreter lock,GIL)来控制,正是由于有GIL,同一时刻只会有一个线程在运行,具体的执行步骤为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1. 设置GIL</span><br><span class="line">2. 切换到一个线程去运行</span><br><span class="line">3. 运行</span><br><span class="line">   a. 运行指定字节码的指令,或者</span><br><span class="line">   b. 线程主动让出控制</span><br><span class="line">4. 把线程设置为睡眠状态</span><br><span class="line">5. 解锁GIL</span><br><span class="line">6. 重复以上所有步骤</span><br></pre></td></tr></table></figure>
<p>所以在调用外部代码的时候,GIL会被锁定,直到调用函数结束为止，看到这里,你可能会觉得Python程序的效率会非常低,毕竟我们的程序会去访问数据库,外部接口,加载本地文件,如果是这样,那我们的程序基本上无时无刻都是卡在那等着。其实你完全不用担心,所有面向I&#x2F;O的(即调用内建的操作系统C代码)的程序,GIL会在这个I&#x2F;O调用之前被释放,这样其他程序是可以在等待I&#x2F;O的时候执行的。不过如果一个程序并没有很多I&#x2F;O操作,那他只要运行,就一直占用CPU,多线程只对那些I&#x2F;O密集的程序更有好处。</p>
<h3 id="threading模块"><a href="#threading模块" class="headerlink" title="threading模块"></a>threading模块</h3><p>其实还有一个模块叫<code>thread</code>,但是这个模块使用特别麻烦,官方不建议使用,其中对于锁的操作特别麻烦,而且还有个很大的问题,一旦主进程退出,不管子线程运行完没有都会被强制结束。所以我也不介绍这个模块怎么用了，我们直接看<code>threading</code>模块的使用。</p>
<h4 id="传入可调用函数"><a href="#传入可调用函数" class="headerlink" title="传入可调用函数"></a>传入可调用函数</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">import threading</span><br><span class="line">from time import sleep, ctime</span><br><span class="line"></span><br><span class="line">__author__ = &#x27;anonymous&#x27;</span><br><span class="line"></span><br><span class="line">loops = [4, 2]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def loop(n_loop, n_sec):</span><br><span class="line">    print &#x27;开始线程&#x27;, n_loop, &#x27;于&#x27;, ctime()</span><br><span class="line">    sleep(n_sec)</span><br><span class="line">    print &#x27;loop函数&#x27;, n_loop, &#x27;完成于&#x27;, ctime()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    print &#x27;开始主线程：&#x27;, ctime()</span><br><span class="line">    threads = []        # 一个用于储存线程对象的列表</span><br><span class="line">    n_loops = range(len(loops))</span><br><span class="line">    for i in n_loops:</span><br><span class="line">        t = threading.Thread(target=loop, args=(i, loops[i]))   # 每次循环创建一个Thread的实例</span><br><span class="line">        threads.append(t)   # 将新创建的对象放到一个列表中</span><br><span class="line"></span><br><span class="line">    for i in n_loops:</span><br><span class="line">        threads[i].start()  # 每次循环运行一个线程</span><br><span class="line"></span><br><span class="line">    or i in n_loops:</span><br><span class="line">        threads[i].join()   # 等待子线程的完成</span><br><span class="line"></span><br><span class="line">    print &#x27;主线程完成：&#x27;, ctime()</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>输出结果为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">开始主线程： Sat Jun 18 19:47:40 2016</span><br><span class="line">开始线程 开始线程0 于  Sat Jun 18 19:47:40 20161</span><br><span class="line"> 于 Sat Jun 18 19:47:40 2016</span><br><span class="line">loop函数 1 完成于 Sat Jun 18 19:47:42 2016</span><br><span class="line">loop函数 0 完成于 Sat Jun 18 19:47:44 2016</span><br><span class="line">主线程完成： Sat Jun 18 19:47:44 2016</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>
<p>一旦调用<code>start()</code>方法被调用的函数就开始执行了,如果你在主函数里面还要做其他操作，并且这个操作与子线程的执行无关，你完全不用调用<code>join()</code>，可以去做其他操作。调用<code>join()</code>会一直等待子线程执行完毕返回然后再执行后面的步骤。<br>**注意:**这个输出并不是连串的,因为我的CPU是多核的，所以日志看上去有点儿不太正常。<code>target</code>一个可调用对象，这里我们传入了一个函数;<code>args</code>是一个元祖，均以位置参数的方式传递给被调用对象。</p>
<h4 id="传入可调用类"><a href="#传入可调用类" class="headerlink" title="传入可调用类"></a>传入可调用类</h4><p>我们也可以传入一个可调用类给<code>Thread</code>实例，不过类必须要实现<code>__call()__</code>方法，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">import threading</span><br><span class="line">from time import sleep, ctime</span><br><span class="line"></span><br><span class="line">__author__ = &#x27;anonymous&#x27;</span><br><span class="line"></span><br><span class="line">loops = [4, 2]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def loop(n_loop, n_sec):</span><br><span class="line">    print &#x27;开始线程&#x27;, n_loop, &#x27;于&#x27;, ctime()</span><br><span class="line">    sleep(n_sec)</span><br><span class="line">    print &#x27;loop函数&#x27;, n_loop, &#x27;完成于&#x27;, ctime()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class ThreadFunc(object):</span><br><span class="line">    def __init__(self, func, args):</span><br><span class="line">        self.func = func</span><br><span class="line">        self.args = args</span><br><span class="line"></span><br><span class="line">    def __call__(self):  # 关键是要实现这个方法</span><br><span class="line">        apply(self.func, self.args)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    print &#x27;开始主线程：&#x27;, ctime()</span><br><span class="line">    threads = []  # 一个用于储存线程对象的列表</span><br><span class="line">    n_loops = range(len(loops))</span><br><span class="line">    for i in n_loops:</span><br><span class="line">        t = threading.Thread(target=ThreadFunc(func=loop, args=(i, loops[i])), )  # 每次循环创建一个Thread的实例，目标是一个类</span><br><span class="line">        threads.append(t)  # 将新创建的对象放到一个列表中</span><br><span class="line"></span><br><span class="line">    for i in n_loops:</span><br><span class="line">        threads[i].start()  # 每次循环运行一个线程</span><br><span class="line"></span><br><span class="line">    for i in n_loops:</span><br><span class="line">        threads[i].join()  # 等待子线程的完成</span><br><span class="line"></span><br><span class="line">    print &#x27;主线程完成：&#x27;, ctime()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>函数的执行结果和上面是一样的，这里我就不再贴运行结果了。</p>
<h4 id="创建Thread子类"><a href="#创建Thread子类" class="headerlink" title="创建Thread子类"></a>创建Thread子类</h4><p>这种方式比较灵活，更加通用，只用在内部冲洗run方法即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">import threading</span><br><span class="line">from time import sleep, ctime</span><br><span class="line"></span><br><span class="line">__author__ = &#x27;anonymous&#x27;</span><br><span class="line"></span><br><span class="line">loops = [4, 2]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def loop(n_loop, n_sec):</span><br><span class="line">    print &#x27;开始线程&#x27;, n_loop, &#x27;于&#x27;, ctime()</span><br><span class="line">    sleep(n_sec)</span><br><span class="line">    print &#x27;loop函数&#x27;, n_loop, &#x27;完成于&#x27;, ctime()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class MyThread(threading.Thread):</span><br><span class="line">    def __init__(self, func, args):</span><br><span class="line">        threading.Thread.__init__(self)  # 调用父类的构造函数</span><br><span class="line">        self.func = func</span><br><span class="line">        self.args = args</span><br><span class="line"></span><br><span class="line">    def run(self):</span><br><span class="line">        apply(self.func, self.args)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    print &#x27;开始主线程：&#x27;, ctime()</span><br><span class="line">    threads = []  # 一个用于储存线程对象的列表</span><br><span class="line">    n_loops = range(len(loops))</span><br><span class="line">    for i in n_loops:</span><br><span class="line">        t = MyThread(func=loop, args=(i, loops[i]))  # 使用我们自己的类来新建对象</span><br><span class="line">        threads.append(t)  # 将新创建的对象放到一个列表中</span><br><span class="line">    for i in n_loops:</span><br><span class="line">        threads[i].start()  # 每次循环运行一个线程</span><br><span class="line"></span><br><span class="line">    for i in n_loops:</span><br><span class="line">        threads[i].join()  # 等待子线程的完成</span><br><span class="line"></span><br><span class="line">    print &#x27;主线程完成：&#x27;, ctime()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>调用子类<code>MyThread</code>的<code>start()</code>方法即可，同样<code>join()</code>用于等待自线程执行完。这种方式相比上面的两种方式好处在哪？想象一下，我们的函数执行如果返回的是一个二维数组，如果仅仅有<code>start(),join()</code>这样的方法，我们怎么获取最后我们执行的返回值呢？如果是子类，我们完全可以在调用<code>run()</code>方法里面把这个结果保存下来，然后最后调用子类的实例去获取这个变量就行了,像下面这样:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">import threading</span><br><span class="line">from time import sleep, ctime</span><br><span class="line"></span><br><span class="line">__author__ = &#x27;anonymous&#x27;</span><br><span class="line"></span><br><span class="line">loops = [4, 2]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def loop(n_loop, n_sec):</span><br><span class="line">    return n_loop + n_sec  # 返回两个参数的和</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class MyThread(threading.Thread):</span><br><span class="line">    def __init__(self, func, args):</span><br><span class="line">        threading.Thread.__init__(self)  # 调用父类的构造函数</span><br><span class="line">        self.func = func</span><br><span class="line">        self.args = args</span><br><span class="line">        self.result = None</span><br><span class="line"></span><br><span class="line">    def run(self):</span><br><span class="line">        self.result = apply(self.func, self.args)  # 调用函数的结果作为一个属性</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    print &#x27;开始主线程：&#x27;, ctime()</span><br><span class="line">    threads = []  # 一个用于储存线程对象的列表</span><br><span class="line">    n_loops = range(len(loops))</span><br><span class="line">    for i in n_loops:</span><br><span class="line">        t = MyThread(func=loop, args=(i, loops[i]))  # 使用我们自己的类来新建对象</span><br><span class="line">        threads.append(t)  # 将新创建的对象放到一个列表中</span><br><span class="line">    for i in n_loops:</span><br><span class="line">        threads[i].start()  # 每次循环运行一个线程</span><br><span class="line"></span><br><span class="line">    for i in n_loops:</span><br><span class="line">        threads[i].join()  # 等待子线程的完成</span><br><span class="line"></span><br><span class="line">    for i in n_loops:</span><br><span class="line">        print &#x27;执行结果为：&#x27;, threads[i].result  # 打印该对象的属性</span><br><span class="line"></span><br><span class="line">    print &#x27;主线程完成：&#x27;, ctime()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>执行结果为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">开始主线程： Sat Jun 18 20:11:51 2016</span><br><span class="line">执行结果为： 4</span><br><span class="line">执行结果为： 3</span><br><span class="line">主线程完成： Sat Jun 18 20:11:51 2016</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<h3 id="Python进程池"><a href="#Python进程池" class="headerlink" title="Python进程池"></a>Python进程池</h3><p>实际在项目中，我们可能会碰到这样的问题，有一个MySQL的表分库分表了，总数大概有1000张，我们想看看每天的数据量有多大，由于这个是线上的库，我们不能开太多的连接，如果把数据库搞挂了不好，但是一个一个去算又太慢，所以需要控制连接的数量，太大太小都不好，这个时候可以使用进程池，控制并发的数量。</p>
<h4 id="进程池-非阻塞"><a href="#进程池-非阻塞" class="headerlink" title="进程池(非阻塞)"></a>进程池(非阻塞)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">__author__ = &#x27;anonymous&#x27;</span><br><span class="line"></span><br><span class="line">from multiprocessing import freeze_support, Pool</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def Foo(i):</span><br><span class="line">    time.sleep(2)</span><br><span class="line">    print &#x27;time start:%s&#x27; % time.strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;)</span><br><span class="line">    return i + 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def Bar(arg):</span><br><span class="line">    print &#x27;time  done:%s %s&#x27; % (time.strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;), arg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    freeze_support()</span><br><span class="line">    pool = Pool(3)  # 线程池中的同时执行的进程数为3</span><br><span class="line"></span><br><span class="line">    for i in range(4):</span><br><span class="line">        pool.apply_async(func=Foo, args=(i,), callback=Bar)  # 线程池中的同时执行的进程数为3，当一个进程执行完毕后，如果还有新进程等待执行，则会将其添加进去</span><br><span class="line"></span><br><span class="line">    print(&#x27;end&#x27;)</span><br><span class="line">    pool.close()</span><br><span class="line">    pool.join()  # 调用join之前，先调用close函数，否则会出错。执行完close后不会有新的进程加入到pool,join函数等待所有子进程结束</span><br></pre></td></tr></table></figure>
<p>输出结果为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">end</span><br><span class="line">time start:2016-06-19 18:08:12</span><br><span class="line">time  done:2016-06-19 18:08:12 100</span><br><span class="line">time start:2016-06-19 18:08:12</span><br><span class="line">time  done:2016-06-19 18:08:12 101</span><br><span class="line">time start:2016-06-19 18:08:12</span><br><span class="line">time  done:2016-06-19 18:08:12 102</span><br><span class="line">time start:2016-06-19 18:08:14</span><br><span class="line">time  done:2016-06-19 18:08:14 103</span><br></pre></td></tr></table></figure>
<p>进程池的大小为3，很明显可以看到，前三个函数的开始时间都是一样的，并且都是不等<code>Foo</code>函数执行完就掉用<code>Bar</code>函数</p>
<ul>
<li><code>apply_async(func[, args[, kwds[, callback]]])</code>它是<strong>非阻塞</strong>，<code>apply(func[, args[, kwds]])</code>是<strong>阻塞</strong>的.</li>
<li><code>close()</code>关闭pool,使其不再接受新的任务</li>
<li><code>join()</code> 主进程阻塞，等待子进程退出，必须在<code>close()</code>和<code>terminate()</code>之后调用</li>
</ul>
<h4 id="进程池-阻塞"><a href="#进程池-阻塞" class="headerlink" title="进程池(阻塞)"></a>进程池(阻塞)</h4><p>和上面的代码差不多，只是把对应部分改一下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">__author__ = &#x27;anonymous&#x27;</span><br><span class="line"></span><br><span class="line">from multiprocessing import freeze_support, Pool</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def Foo(i):</span><br><span class="line">    time.sleep(2)</span><br><span class="line">    print &#x27;time start:%s&#x27; % time.strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;)</span><br><span class="line">    return i + 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def Bar(arg):</span><br><span class="line">    print &#x27;time  done:%s %s&#x27; % (time.strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;), arg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    freeze_support()</span><br><span class="line">    pool = Pool(3)  # 线程池中的同时执行的进程数为3</span><br><span class="line"></span><br><span class="line">    for i in range(4):</span><br><span class="line">        pool.apply(func=Foo, args=(i,))</span><br><span class="line"></span><br><span class="line">    print(&#x27;end&#x27;)</span><br><span class="line">    pool.close()</span><br><span class="line">    pool.join()  # 调用join之前，先调用close函数，否则会出错。执行完close后不会有新的进程加入到pool,join函数等待所有子进程结束</span><br></pre></td></tr></table></figure>
<p>执行结果如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">time start:2016-06-19 18:14:00</span><br><span class="line">time start:2016-06-19 18:14:02</span><br><span class="line">time start:2016-06-19 18:14:04</span><br><span class="line">time start:2016-06-19 18:14:06</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h4 id="进程池-关注返回结果"><a href="#进程池-关注返回结果" class="headerlink" title="进程池(关注返回结果)"></a>进程池(关注返回结果)</h4><p>多半情况下我们还是要关注函数的执行返回结果，并不能完全想像上面那样阻塞运行或者非阻塞等函未执行完就调用回调函数:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">import multiprocess</span><br><span class="line"></span><br><span class="line">__author__ = &#x27;anonymous&#x27;</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def func(msg):</span><br><span class="line">    print &#x27;time start:%s&#x27; % time.strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;)</span><br><span class="line">    time.sleep(2)</span><br><span class="line">    print &#x27;time   end:%s&#x27; % time.strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;)</span><br><span class="line">    return &#x27;done&#x27; + msg</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    pool = multiprocess.Pool(2)</span><br><span class="line">    result = []</span><br><span class="line"></span><br><span class="line">    for i in range(3):</span><br><span class="line">        msg = &#x27;hello %s&#x27; % i</span><br><span class="line">        result.append(pool.apply_async(func=func, args=(msg,)))</span><br><span class="line"></span><br><span class="line">    pool.close()</span><br><span class="line">    pool.join()</span><br><span class="line"></span><br><span class="line">    for res in result:</span><br><span class="line">        print &#x27;***: %s&#x27; % res.get()</span><br><span class="line"></span><br><span class="line">    print &#x27;end&#x27;</span><br></pre></td></tr></table></figure>
<p>执行看一下返回结果是啥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">time start:2016-06-19 18:43:22</span><br><span class="line">time start:2016-06-19 18:43:22</span><br><span class="line">time   end:2016-06-19 18:43:24</span><br><span class="line">time start:2016-06-19 18:43:24</span><br><span class="line">time   end:2016-06-19 18:43:24</span><br><span class="line">time   end:2016-06-19 18:43:26</span><br><span class="line">***: done hello 0</span><br><span class="line">***: done hello 1</span><br><span class="line">***: done hello 2</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>可以看到，我们可以使用<code>get()</code>方法获取被调用函数的返回值</p>
<h4 id="multiprocessing"><a href="#multiprocessing" class="headerlink" title="multiprocessing"></a>multiprocessing</h4><p>还有一种方式，可以使用<code>pool.map()</code>，以我们最开始的例子为例，我们要查询1000张表，可以把参数放在一个可迭代对象里，使用pool.map()找依次多个处理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">import multiprocessing</span><br><span class="line"></span><br><span class="line">__author__ = &#x27;anonymous&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def m1(x):</span><br><span class="line">    return x * x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    pool = multiprocessing.Pool(multiprocessing.cpu_count())</span><br><span class="line">    i_list = range(8)</span><br><span class="line">    result = pool.map(m1, i_list)</span><br><span class="line"></span><br><span class="line">    print sum(result)</span><br></pre></td></tr></table></figure>
<p>执行结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">140</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://sjq597.github.io/2016/05/29/Ubuntu-%E5%90%AF%E5%8A%A8%E6%A0%8F%E5%BA%94%E7%94%A8%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LittleQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LittleQ">
      <meta itemprop="description" content="数据开发工程师的成长历程">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LittleQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/05/29/Ubuntu-%E5%90%AF%E5%8A%A8%E6%A0%8F%E5%BA%94%E7%94%A8%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" class="post-title-link" itemprop="url">Ubuntu 启动栏应用无法启动解决方案</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-05-29 19:36:35" itemprop="dateCreated datePublished" datetime="2016-05-29T19:36:35+08:00">2016-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-07 14:54:54" itemprop="dateModified" datetime="2023-10-07T14:54:54+08:00">2023-10-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux%E4%BD%BF%E7%94%A8/" itemprop="url" rel="index"><span itemprop="name">Linux使用</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>689</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>最近刚装好了Ubuntu16.04，好不容易配置好了开发环境，突然发现IDEA,和PyCharm无法从启动栏和Dash菜单中启动，摸索来一阵之后，查阅资料发现来问题所在,记录一下，也希望给其他人一点参考，简单来说就是，环境变量不对导致无法启动。<br>以IntelliJ IDEA为例，我的IDEA和Pycharm都只能从终端启动，很不方便，即是从终端启动了，我把图标固定在左侧的快速启动栏，仍然启动不了，下面看看解决办法。<br>首先去<code>~/.local/share/applications</code>目录看下有没有你的应用程序启动文件,关键字搜索一下,如果没有就去<code>/usr/share/applications</code>文件夹看看，找到你的程序，双击，如果能够启动则应该没是没有问题的，但是双击不能启动，则即使你把图标固定到快速启动栏，程序仍然启动不了。<br>双击<code>IntelliJ IDEA</code>图标，提示报错信息，找不到JDK,问题就出在这里，但是奇怪的是我明明装了JDK,也设置来环境变量，怎么会找不到呢？于是我用vim查看了一下这个启动项的具体配置:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ cd /usr/share/applications</span><br><span class="line">$ cat jetbrains-idea.desktop</span><br><span class="line">[Desktop Entry]</span><br><span class="line">Version=1.0</span><br><span class="line">Type=Application</span><br><span class="line">Name=IntelliJ IDEA</span><br><span class="line">Icon=/usr/dev/idea-IU-139.1117.1/bin/idea.png</span><br><span class="line">Exec=&quot;/usr/dev/idea-IU-139.1117.1/bin/idea.sh&quot; %f</span><br><span class="line">Comment=Develop with pleasure!</span><br><span class="line">Categories=Development;IDE;</span><br><span class="line">Terminal=false</span><br><span class="line">StartupWMClass=jetbrains-idea</span><br></pre></td></tr></table></figure>
<p>可以看到启动程序调用的脚本路径<code>/usr/dev/idea-IU-139.1117.1/bin/idea.sh</code>，这个就是我IDEA的解压安装路径，但是奇怪的是我从终端启动也是运行的这个脚本，就可以启动，为什么系统调用就不行呢？而且错误信息提示的是找不到JDK,后来我才明白，原来我安装了zsh,所以设置在<code>~/.zshrc</code>里面的环境变量并不能对bash启动的程序生效，所以找不到JDK。<br>既然明白了问题所在，解决办法也就有了,要么把环境变量设置成系统级别的环境变量，要么直接在对应的启动脚本中加入JDK的路径:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ cat /usr/dev/idea-IU-139.1117.1/bin/idea.sh</span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line"># Locate a JDK installation directory which will be used to run the IDE.</span><br><span class="line"># Try (in order): IDEA_JDK, JDK_HOME, JAVA_HOME, &quot;java&quot; in PATH.</span><br><span class="line"># ---------------------------------------------------------------------</span><br><span class="line">if [ -n &quot;$IDEA_JDK&quot; -a -x &quot;$IDEA_JDK/bin/java&quot; ]; then</span><br><span class="line">  JDK=&quot;$IDEA_JDK&quot;</span><br><span class="line">elif [ -n &quot;$JDK_HOME&quot; -a -x &quot;$JDK_HOME/bin/java&quot; ]; then</span><br><span class="line">  JDK=&quot;$JDK_HOME&quot;</span><br><span class="line">elif [ -n &quot;$JAVA_HOME&quot; -a -x &quot;$JAVA_HOME/bin/java&quot; ]; then</span><br><span class="line">  JDK=&quot;$JAVA_HOME&quot;</span><br><span class="line">else</span><br><span class="line">  JAVA_BIN_PATH=`which java`</span><br><span class="line">.......</span><br></pre></td></tr></table></figure>
<p>分析启动脚本，反正就是找不到JAVA_HOME,JDK的路径了,简单粗暴的直接在检查变量之前定义好,在注释下面，条件判断的前面加上JAVA的配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JAVA_HOME=/usr/dev/jdk1.7.0_40</span><br><span class="line">JRE_HOME=$&#123;JAVA_HOME&#125;/jre</span><br></pre></td></tr></table></figure>
<p>这样再点击图标就可以运行了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://sjq597.github.io/2016/05/29/Hive-%E6%AD%A3%E5%88%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LittleQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LittleQ">
      <meta itemprop="description" content="数据开发工程师的成长历程">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LittleQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/05/29/Hive-%E6%AD%A3%E5%88%99/" class="post-title-link" itemprop="url">Hive 正则</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-05-29 17:53:35" itemprop="dateCreated datePublished" datetime="2016-05-29T17:53:35+08:00">2016-05-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-07 14:54:54" itemprop="dateModified" datetime="2023-10-07T14:54:54+08:00">2023-10-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Hive%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Hive笔记</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>427</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>分析日志经常要用到正则来提取需要分析的关键信息,其中需要注意的就是,Hive本身史用Java写的，所以HQL里面的正则和Java里面史一样的，但是具体在使用的时候，会碰到很多问题，就是转义的问题，总结了一下在各个语言中使用HQL时正则的不同情况。</p>
<h3 id="Hive-Cli"><a href="#Hive-Cli" class="headerlink" title="Hive Cli"></a>Hive Cli</h3><p>平时使用的时候，很多情况下都是在Hive Cli客户端中使用，这里和正常的正则需要稍微有一些区别,例如匹配数字，正常情况下就<code>\d</code>，但是在Hive Cli中需要注意,应该使用<code>\\d</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select</span><br><span class="line">  regexp_extract(content, &#x27;.*id=(\\d*).*&#x27;, 1) as id </span><br><span class="line">from</span><br><span class="line">  test.table_test;</span><br></pre></td></tr></table></figure>
<h3 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h3><p>还有一种更为常见的使用场景，就是在Shell脚本中使用，Shell脚本中又涉及到单引号和双引号的区别,单引号史强引用类型,<code>\</code>不会被转义，但是双引号字符串则会转义，例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">reg_str1=&#x27;.*id=(\\d*).*&#x27;</span><br><span class="line">reg_str2=&quot;.*id=(\\\\d*).*&quot;</span><br><span class="line"></span><br><span class="line">sudo -uhiev_user /usr/dev/hive-1.2.0/bin/hive -e &quot;</span><br><span class="line">select</span><br><span class="line">  regexp_extract(content, &#x27;$&#123;reg_str1&#125;&#x27;, 1) as id1, </span><br><span class="line">  regexp_extract(content, &#x27;$&#123;reg_str2&#125;&#x27;, 1) as id2 </span><br><span class="line">from</span><br><span class="line">  test.table_test;</span><br><span class="line">&quot;</span><br></pre></td></tr></table></figure>
<p>这两个正则表达式是一样的，其实确认你的HQL正则表达式是否有用，可以先用echo在sudo前面看看，如果输出的史<code>\\d</code>则说明有用</p>
<h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><p>有时候需要在Python中执行HQL,好像Hive并不支持Python接口,所以我采取的是在Python中执行Shel命令</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bash_cmd为Shell命令</span></span><br><span class="line">bash_cmd = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">sudo -uhive_user /usr/dev/hive-1.2.0/bin/hive -e &quot;&#123;0&#125;&quot;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.<span class="built_in">format</span>(sql)	<span class="comment"># sql即为要执行的HQL</span></span><br><span class="line"></span><br><span class="line">hql_process = subprocess.Popen(bash_cmd, shell=<span class="literal">True</span>, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)</span><br></pre></td></tr></table></figure>
<p>在Python中我定义来一个sql</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">select</span></span><br><span class="line"><span class="string">  regexp_extract(content, &#x27;.*id=(\\\\\\d*).*&#x27;, 1) as id </span></span><br><span class="line"><span class="string">from</span></span><br><span class="line"><span class="string">  test.table_test;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://sjq597.github.io/2016/04/30/Flask-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LittleQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LittleQ">
      <meta itemprop="description" content="数据开发工程师的成长历程">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LittleQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/04/30/Flask-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-02/" class="post-title-link" itemprop="url">Flask 学习笔记 02</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-04-30 14:03:37" itemprop="dateCreated datePublished" datetime="2016-04-30T14:03:37+08:00">2016-04-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-07 14:54:54" itemprop="dateModified" datetime="2023-10-07T14:54:54+08:00">2023-10-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Flask/" itemprop="url" rel="index"><span itemprop="name">Flask</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>从简单的例子学习Flask,因为是简单的例子，就用子单的<code>sqlite3</code>数据库了，如果项目大了，数据量大可以考虑使用<code>MySQL</code>。</p>
<h3 id="项目步骤"><a href="#项目步骤" class="headerlink" title="项目步骤"></a>项目步骤</h3><p>一步步来演示一个项目是如何创建的</p>
<ul>
<li>先创建文件夹<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  flasker  tree</span><br><span class="line">.</span><br><span class="line">├── static</span><br><span class="line">└── templates</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="数据库模式，将下面的内容保存在schema-sql，放在flasker目录下就行"><a href="#数据库模式，将下面的内容保存在schema-sql，放在flasker目录下就行" class="headerlink" title="数据库模式，将下面的内容保存在schema.sql，放在flasker目录下就行:"></a>数据库模式，将下面的内容保存在<code>schema.sql</code>，放在<code>flasker</code>目录下就行:</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">drop table if exists entries;</span><br><span class="line">create table entries (</span><br><span class="line">  id integer primary key autoincrement,</span><br><span class="line">  title text not null,</span><br><span class="line">  text text not null</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h4 id="应用构建"><a href="#应用构建" class="headerlink" title="应用构建"></a>应用构建</h4><p>创建应用模块，吧模块命名为<code>flaskr.py</code>,就放在flaskr文件夹中，为了方便学习，把库的导入和相关配置放在了一起，但是一个清晰的方案应该是放在一个独立的<code>__init__.py</code>文件中，然后在模块里导入配置，不过这个也有一个不好的地方，就是你在主文件里不知道的包到底是从哪导入的,flaskr.py内容如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># all the imports</span><br><span class="line">import sqlite3</span><br><span class="line">from flask import Flask, request, session, g, redirect, url_for, \</span><br><span class="line">     abort, render_template, flash</span><br><span class="line"></span><br><span class="line"># configuration</span><br><span class="line">DATABASE = &#x27;/tmp/r.db&#x27;</span><br><span class="line">DEBUG = True</span><br><span class="line">SECRET_KEY = &#x27;development key&#x27;</span><br><span class="line">USERNAME = &#x27;admin&#x27;</span><br><span class="line">PASSWORD = &#x27;default&#x27;</span><br></pre></td></tr></table></figure>
<p>然后在同一个文件中创建真正的应用，使用配置来初始化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># create our little application :)</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config.from_object(__name__)</span><br></pre></td></tr></table></figure>
<p><code>from_object</code>的传入参数如果是字符串则直接导入，它会搜索加载多有大写的变量名，就是我们写在最前面的，你也可以把这个写在<code>__init__.py</code>文件中。一般都是总配置文件导入配置的，建议使用<code>from_envvar()</code>来导入配置，上面的第二行可以替换为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.config.from_envvar(&#x27;FLASKR_SETTINGS&#x27;, silent=True)</span><br></pre></td></tr></table></figure>
<p>这个可以设置一个<code>FLASKR_SETTINGS</code>变量来指定一个配置文件，并根据该文件来重载缺省配置，<code>silent</code>意思是如果没有，则不报错。<br>然后添加一个用于连接数据库的方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def connect_db():</span><br><span class="line">    return sqlite3.connect(app.config[&#x27;DATABASE&#x27;])</span><br></pre></td></tr></table></figure>
<p>然后在最后以单机模式启动的代码:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>
<p>这样虽然可以启动服务器，但是无法访问界面，因为没有构建任何视图。</p>
<h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h4><p>每次去执行命令导入不是很方便，受限于系统，所以添加一个数据库初始化函数，首先要导入<code>contextlib.closing()</code>函数,即:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from contextlib import closing</span><br></pre></td></tr></table></figure>
<p>然后创建一个初始数据库的函数<code>init_db()</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def init_db():</span><br><span class="line">    with closing(connect_db()) as db:</span><br><span class="line">        with app.open_resource(&#x27;schema.sql&#x27;, mode=&#x27;r&#x27;) as f:</span><br><span class="line">            db.cursor().executescript(f.read())</span><br><span class="line">        db.commit()</span><br></pre></td></tr></table></figure>
<p><code>closing()</code>函数允许我们在with代码块中保持数据库打开，然后<code>open_resouce()</code>也支持这个功能，直接在with代码块中使用，<code>sqlite3</code>里面的sql都必须显示的提交才会生效。</p>
<h4 id="请求数据库连接"><a href="#请求数据库连接" class="headerlink" title="请求数据库连接"></a>请求数据库连接</h4><p>当然你可以生成一个全局的数据库连接句柄，这样在每个函数里面就可以使用数据库连接了，但是并不推荐这样，会带来很多问题，也不够优雅。Flask里面利用装饰器能够做到优雅的访问数据库，<code>before_request()</code>,<code>after_request()</code>,<code>teardown_request()</code>这三个装饰器就可以满足需求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@app.before_request</span><br><span class="line">def before_request():</span><br><span class="line">    g.db = connect_db()</span><br><span class="line"></span><br><span class="line">@app.teardown_request</span><br><span class="line">def teardown_request(exception):</span><br><span class="line">    db = getattr(g, &#x27;db&#x27;, None)</span><br><span class="line">    if db is not None:</span><br><span class="line">        db.close()</span><br><span class="line">    g.db.close()</span><br></pre></td></tr></table></figure>
<p>来看看这段代码是如何的优雅，使用<code>before_request()</code>装饰函数会在请求之前调用，不用传递任何参数，这样在每个视图函数里面都可以通过全局<code>g</code>对象获取数据库连接句柄。使用<code>after_request()</code>会在请求之后调用，并且会传递相应对象给客户端，所以出错了就不会执行。因此需要用到第三个装饰器<code>teardown_request()</code>装饰器，这个装饰器会在响应对象构建完之后才调用被装饰的函数，不允许修改请求，而且返回值也会被忽略，如果出错了，这个错误会传递给每个函数。这里的<code>g</code>对象简单理解就是一个神奇的全局对象，并且多线程也可以正常工作。</p>
<h4 id="视图函数"><a href="#视图函数" class="headerlink" title="视图函数"></a>视图函数</h4><p>在数据库连接处理完之后，就可以来构造视图了，下面简单介绍一个例子：</p>
<h5 id="显示条目"><a href="#显示条目" class="headerlink" title="显示条目"></a>显示条目</h5><p>这个视图将会显示所有数据库中的连接，模板为<code>show_entries.html</code>,并返回渲染结果:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def show_entries():</span><br><span class="line">    cur = g.db.execute(&#x27;select title, text from entries order by id desc&#x27;)</span><br><span class="line">    entries = [dict(title=row[0], text=row[1]) for row in cur.fetchall()]</span><br><span class="line">    return render_template(&#x27;show_entries.html&#x27;, entries=entries)</span><br></pre></td></tr></table></figure>
<h4 id="添加条目"><a href="#添加条目" class="headerlink" title="添加条目"></a>添加条目</h4><p>添加一条新记录，添加完之后并不会显示，结果显示在<code>show_entries</code>页面中，如果成功，则会flash()一个消息给下一个请求并重定向到<code>show_entries</code>页面：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#x27;/add&#x27;, methods=[&#x27;POST&#x27;])</span><br><span class="line">def add_entry():</span><br><span class="line">    if not session.get(&#x27;logged_in&#x27;):</span><br><span class="line">        abort(401)</span><br><span class="line">    g.db.execute(&#x27;insert into entries (title, text) values (?, ?)&#x27;,</span><br><span class="line">                 [request.form[&#x27;title&#x27;], request.form[&#x27;text&#x27;]])</span><br><span class="line">    g.db.commit()</span><br><span class="line">    flash(&#x27;New entry was successfully posted&#x27;)</span><br><span class="line">    return redirect(url_for(&#x27;show_entries&#x27;))</span><br></pre></td></tr></table></figure>
<p>这里还有个检查是否登陆的，就是<code>logged_in</code>是否为<code>True</code>。另外一个，为了防止SQL注入，劲量不要拼sql,用<code>?</code>代替。</p>
<h4 id="登陆和注销"><a href="#登陆和注销" class="headerlink" title="登陆和注销"></a>登陆和注销</h4><p>用于登陆和注销，根据配置中的用户名和密码验证用户会话中设置<code>logged_in</code>的键值。如果通过验证，则设置<code>logged_in</code>为True,然后重定向到<code>show_entries</code>页面。另外闪现一个信息，告诉用户已登陆成功，如果出错，则提示错误信息，并重新登陆:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#x27;/login&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span><br><span class="line">def login():</span><br><span class="line">    error = None</span><br><span class="line">    if request.method == &#x27;POST&#x27;:</span><br><span class="line">        if request.form[&#x27;username&#x27;] != app.config[&#x27;USERNAME&#x27;]:</span><br><span class="line">            error = &#x27;Invalid username&#x27;</span><br><span class="line">        elif request.form[&#x27;password&#x27;] != app.config[&#x27;PASSWORD&#x27;]:</span><br><span class="line">            error = &#x27;Invalid password&#x27;</span><br><span class="line">        else:</span><br><span class="line">            session[&#x27;logged_in&#x27;] = True</span><br><span class="line">            flash(&#x27;You were logged in&#x27;)</span><br><span class="line">            return redirect(url_for(&#x27;show_entries&#x27;))</span><br><span class="line">    return render_template(&#x27;login.html&#x27;, error=error)</span><br></pre></td></tr></table></figure>
<p>注销视图则会相反，移除键值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#x27;/logout&#x27;)</span><br><span class="line">def logout():</span><br><span class="line">    session.pop(&#x27;logged_in&#x27;, None)</span><br><span class="line">    flash(&#x27;You were logged out&#x27;)</span><br><span class="line">    return redirect(url_for(&#x27;show_entries&#x27;))</span><br></pre></td></tr></table></figure>
<p>使用<code>pop()</code>函数如果传递了第二个参数(键的缺省值),如果有的话就会删掉，如果没有，就啥也不做。</p>
<h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><p>光有视图还不够，上面用到的模板还没有写好，访问也会报错，然后还用到了模板继承保存所有页面布局统一，这些文件都保存在<code>templates</code>文件夹中:</p>
<h4 id="layout-html"><a href="#layout-html" class="headerlink" title="layout.html"></a>layout.html</h4><p>这个模板包含了HTML的骨架，头部和一个登陆链接(如果用户已登陆则变为一个注销连接)。如果有闪现消息，则也显示出来:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block body %&#125;</span><br></pre></td></tr></table></figure>
<p>上面的块儿会被子模块中同名的body替换。而且session在模板中也可以使用，如果键值(属性)不存在也可以正常运行：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Flaskr<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">stylesheet</span> <span class="attr">type</span>=<span class="string">text/css</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;style.css&#x27;) &#125;&#125;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">page</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Flaskr<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">metanav</span>&gt;</span></span><br><span class="line">  &#123;% if not session.logged_in %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; url_for(&#x27;login&#x27;) &#125;&#125;&quot;</span>&gt;</span>log in<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  &#123;% else %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; url_for(&#x27;logout&#x27;) &#125;&#125;&quot;</span>&gt;</span>log out<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  &#123;% for message in get_flashed_messages() %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">flash</span>&gt;</span>&#123;&#123; message &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line">  &#123;% block body %&#125;&#123;% endblock %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="show-entries-html"><a href="#show-entries-html" class="headerlink" title="show_entries.html"></a>show_entries.html</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;layout.html&quot; %&#125;</span><br><span class="line">&#123;% block body %&#125;</span><br><span class="line">  &#123;% if session.logged_in %&#125;</span><br><span class="line">    &lt;form action=&quot;&#123;&#123; url_for(&#x27;add_entry&#x27;) &#125;&#125;&quot; method=post class=add-entry&gt;</span><br><span class="line">      &lt;dl&gt;</span><br><span class="line">        &lt;dt&gt;Title:</span><br><span class="line">        &lt;dd&gt;&lt;input type=text size=30 name=title&gt;</span><br><span class="line">        &lt;dt&gt;Text:</span><br><span class="line">        &lt;dd&gt;&lt;textarea name=text rows=5 cols=40&gt;&lt;/textarea&gt;</span><br><span class="line">        &lt;dd&gt;&lt;input type=submit value=Share&gt;</span><br><span class="line">      &lt;/dl&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line">  &lt;ul class=entries&gt;</span><br><span class="line">  &#123;% for entry in entries %&#125;</span><br><span class="line">    &lt;li&gt;&lt;h2&gt;&#123;&#123; entry.title &#125;&#125;&lt;/h2&gt;&#123;&#123; entry.text|safe &#125;&#125;</span><br><span class="line">  &#123;% else %&#125;</span><br><span class="line">    &lt;li&gt;&lt;em&gt;Unbelievable.  No entries here so far&lt;/em&gt;</span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line">  &lt;/ul&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>我们在第一行使用了<code>layout.html</code>模板，扩展了基础模板，用于显示信息。for遍历了我们通过<code>render_template()</code>函数所有传递信息。模板也指明了method为post提交数据。</p>
<h4 id="login-html"><a href="#login-html" class="headerlink" title="login.html"></a>login.html</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &quot;layout.html&quot; %&#125;</span><br><span class="line">&#123;% block body %&#125;</span><br><span class="line">  &lt;h2&gt;Login&lt;/h2&gt;</span><br><span class="line">  &#123;% if error %&#125;&lt;p class=error&gt;&lt;strong&gt;Error:&lt;/strong&gt; &#123;&#123; error &#125;&#125;&#123;% endif %&#125;</span><br><span class="line">  &lt;form action=&quot;&#123;&#123; url_for(&#x27;login&#x27;) &#125;&#125;&quot; method=post&gt;</span><br><span class="line">    &lt;dl&gt;</span><br><span class="line">      &lt;dt&gt;Username:</span><br><span class="line">      &lt;dd&gt;&lt;input type=text name=username&gt;</span><br><span class="line">      &lt;dt&gt;Password:</span><br><span class="line">      &lt;dd&gt;&lt;input type=password name=password&gt;</span><br><span class="line">      &lt;dd&gt;&lt;input type=submit value=Login&gt;</span><br><span class="line">    &lt;/dl&gt;</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<h3 id="添加样式"><a href="#添加样式" class="headerlink" title="添加样式"></a>添加样式</h3><p>现在数据库连接有了，视图也有了，然后模板也有了，最后就差样式了，我们来添加一下样式，保存为<code>style.css</code>保存在<code>static</code>文件夹中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">body            &#123; font-family: sans-serif; background: #eee; &#125;</span><br><span class="line">a, h1, h2       &#123; color: #377ba8; &#125;</span><br><span class="line">h1, h2          &#123; font-family: &#x27;Georgia&#x27;, serif; margin: 0; &#125;</span><br><span class="line">h1              &#123; border-bottom: 2px solid #eee; &#125;</span><br><span class="line">h2              &#123; font-size: 1.2em; &#125;</span><br><span class="line"></span><br><span class="line">.page           &#123; margin: 2em auto; width: 35em; border: 5px solid #ccc;</span><br><span class="line">                  padding: 0.8em; background: white; &#125;</span><br><span class="line">.entries        &#123; list-style: none; margin: 0; padding: 0; &#125;</span><br><span class="line">.entries li     &#123; margin: 0.8em 1.2em; &#125;</span><br><span class="line">.entries li h2  &#123; margin-left: -1em; &#125;</span><br><span class="line">.add-entry      &#123; font-size: 0.9em; border-bottom: 1px solid #ccc; &#125;</span><br><span class="line">.add-entry dl   &#123; font-weight: bold; &#125;</span><br><span class="line">.metanav        &#123; text-align: right; font-size: 0.8em; padding: 0.3em;</span><br><span class="line">                  margin-bottom: 1em; background: #fafafa; &#125;</span><br><span class="line">.flash          &#123; background: #cee5F5; padding: 0.5em;</span><br><span class="line">                  border: 1px solid #aacbe2; &#125;</span><br><span class="line">.error          &#123; background: #f0d6d6; padding: 0.5em; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试Flask"><a href="#测试Flask" class="headerlink" title="测试Flask"></a>测试Flask</h3><p>这个必须介绍一下，因为写代码的过程中免不了要调试和测试，现在讲一下怎么用<code>unittest</code>包来测试flask应用</p>
<h4 id="测试骨架"><a href="#测试骨架" class="headerlink" title="测试骨架"></a>测试骨架</h4><p>为了测试我们的应用，我们添加一个新的模块<code>flaskr_tests.py</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">import flaskr</span><br><span class="line">import unittest</span><br><span class="line">import tempfile</span><br><span class="line"></span><br><span class="line">class FlaskrTestCase(unittest.TestCase):</span><br><span class="line"></span><br><span class="line">    def setUp(self):</span><br><span class="line">        self.db_fd, flaskr.app.config[&#x27;DATABASE&#x27;] = tempfile.mkstemp()</span><br><span class="line">        flaskr.app.config[&#x27;TESTING&#x27;] = True</span><br><span class="line">        self.app = flaskr.app.test_client()</span><br><span class="line">        flaskr.init_db()</span><br><span class="line"></span><br><span class="line">    def tearDown(self):</span><br><span class="line">        os.close(self.db_fd)</span><br><span class="line">        os.unlink(flaskr.app.config[&#x27;DATABASE&#x27;])</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    unittest.main()</span><br></pre></td></tr></table></figure>
<p>稍微介绍一下这个测试是个啥意思:</p>
<ol>
<li><code>setUp()</code>方法中会创建一个新的测试客户端并出书画了一个连接，每一个独立的测试函数运行之前都要调用这个函数</li>
<li><code>tearDown()</code>功能是在测试结束以后关闭文件，并在文件中删除数据库库文件，另外<code>TESTING=True</code>,这意味着在请求时关闭错误捕捉，这样可以真实的捕捉到错误，得到更好的错误报告。</li>
</ol>
<p>测试客户端会提供一个简单的应用接口，我们通过这个接口向应用发送测试请求，还可以追踪cookies。<br>因为<code>sqlite3</code>是一个文件系统数据库，所以可以使用临时文件来创建一个临时数据库并初始化它。<code>mkstemp()</code>函数返回两个东西:一个低级别的文件句柄和一个随机文件名,这个文件名将会作为我们的数据库名称。必须把句柄保存到<code>self.db_fd</code>种，这样在整个测试类里面才能在其他方法中来关闭文件。<br>可以在终端中运行测试程序，如果没有报错，才说明没有语法错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(env)➜  flasker  python flaskr_tests.py </span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">Ran 0 tests in 0.000s</span><br><span class="line"></span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<h4 id="第一个测试"><a href="#第一个测试" class="headerlink" title="第一个测试"></a>第一个测试</h4><p>Web应用就是测试一些URL访问是否正常，添加一个访问URL(&#x2F;)的方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class FlaskrTestCase(unittest.TestCase):</span><br><span class="line"></span><br><span class="line">    def setUp(self):</span><br><span class="line">        self.db_fd, flaskr.app.config[&#x27;DATABASE&#x27;] = tempfile.mkstemp()</span><br><span class="line">        self.app = flaskr.app.test_client()</span><br><span class="line">        flaskr.init_db()</span><br><span class="line"></span><br><span class="line">    def tearDown(self):</span><br><span class="line">        os.close(self.db_fd)</span><br><span class="line">        os.unlink(flaskr.app.config[&#x27;DATABASE&#x27;])</span><br><span class="line"></span><br><span class="line">    def test_empty_db(self):</span><br><span class="line">        rv = self.app.get(&#x27;/&#x27;)</span><br><span class="line">        assert &#x27;No entries here so far&#x27; in rv.data</span><br></pre></td></tr></table></figure>
<p><strong>注意:<strong>测试的函数都是以<code>test</code>开始的，这样<code>unittest</code>就会自动识别这些用于测试的函数并运行它们。通过使用<code>self.app.get()</code>可以给制定的URL发送</strong>HTTP GET</strong>请求，其返回的是一个<code>～flask.Flask.reponse_class</code>对象，通过检查其data属性来检测其返回值</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://sjq597.github.io/2016/04/24/Flask-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B001/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LittleQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LittleQ">
      <meta itemprop="description" content="数据开发工程师的成长历程">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LittleQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/04/24/Flask-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B001/" class="post-title-link" itemprop="url">Flask 学习笔记01 </a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-04-24 18:56:39" itemprop="dateCreated datePublished" datetime="2016-04-24T18:56:39+08:00">2016-04-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-07 14:54:54" itemprop="dateModified" datetime="2023-10-07T14:54:54+08:00">2023-10-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Flask/" itemprop="url" rel="index"><span itemprop="name">Flask</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>12 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>由于平时经常使用Python,所以想使用Python的微框架开发一些简单的工具来提升工作效率，特此记录一下学习Flask的笔记。</p>
<h3 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h3><p>本机系统: Ubuntu 14.04 64bits<br>所有的学习第一步就是配置开发环境，还好Ubuntu自带了Python,这里采用的虚拟Python配置，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install python-virtualenv</span><br></pre></td></tr></table></figure>
<p>或者使用pip安装:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ $ sudo pip install virtualenv</span><br></pre></td></tr></table></figure>
<p>如果你是Windows用户，并且你已经安装了<code>pip</code>工具，则去掉<code>sudo</code>在cmd命令下也可以安装<br>然后创建一个包含<code>venv</code>的文件夹的项目文件夹，项目就建在这里面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir flask_project</span><br><span class="line">$ cd flask_project</span><br><span class="line">$ sudo virtualenv venv</span><br></pre></td></tr></table></figure>
<p>现在每次要使用项目，就可以在<code>flask_project</code>文件夹中运行下面的命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ . venv/bin/activate</span><br></pre></td></tr></table></figure>
<p>对应的Windows启动命令为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ . venv/Scripts/activate</span><br></pre></td></tr></table></figure>
<p>你现在进入你的virtualenv(注意查看你的shell提示符已经改变了)。每次需要安装包的时候就先激活虚拟环境，下面安装<code>flask</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask</span><br></pre></td></tr></table></figure>
<p>**注意:**这里有个地方需要个别强调一下，安装包不能使用sudo权限来安装，如果不带<code>sudo</code>安装提示权限不够，请把<code>flask_project</code>文件夹的权限设置为当前用户,例如，当前用户为<code>zhangsan</code>,在<code>flask_project</code>的父目录执行:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown zhangsan:zhangsan -R flask_project</span><br></pre></td></tr></table></figure>
<p>相应的退出使用:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ deactivate</span><br></pre></td></tr></table></figure>

<h3 id="一个最简单的应用"><a href="#一个最简单的应用" class="headerlink" title="一个最简单的应用"></a>一个最简单的应用</h3><p>在<code>flask_project</code>文件夹中创建一个文件<code>hello.py</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def hello_world():</span><br><span class="line">    return &#x27;Hello World!&#x27;</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>
<p>在命令行或者终端里运行:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python hello.py</span><br></pre></td></tr></table></figure>
<p>然后在浏览器打开<code>http://127.0.0.1:5000/</code>就可以看到一个最简单的hello world页面了。大概解释一下：</p>
<ol>
<li>首先我们导入了<strong>Flask</strong>类。这个类的实例将会成为我们的<strong>WSGI</strong>应用,即后面的<strong>app</strong>。</li>
<li>接着我们创建了这个类的实例。第一个参数是应用模块或者包的名称。如果你使用一个 单一模块（就像本例），那么应当使用<code>__name__</code>,因为名称会根据这个模块是按 应用方式使用还是作为一个模块导入而发生变化（可能是<code>__main__</code>，也可能是 实际导入的名称）。这个参数是必需的，这样<strong>Flask</strong>就可以知道在哪里找到模板和 静态文件等东西。不明白也没关系，先这么写，后面慢慢会深入研究。</li>
<li>然后我们使用<code>route()</code>装饰器来告诉<strong>Flask</strong>触发函数的<strong>URL</strong>。函数名称可用于生成相关联的<strong>URL</strong>，并返回需要在用户浏览器中显示的信息。这个和Java里的<strong>Controller</strong>非常的像，用过Spring的同学对此应该很熟悉。</li>
<li>最后，使用<code>run()</code>函数来运行本地服务器和我们的应用。<code>if __name__ == &#39;__main__&#39;:</code> 确保服务器只会在使用Python解释器运行代码的情况下运行，而不会在作为模块导入时运行。</li>
</ol>
<p>本机访问没问题，但是局域网的其他机器如果也想访问，则需要这样启动:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.run(host=&#x27;0.0.0.0&#x27;)</span><br></pre></td></tr></table></figure>
<p>这行代码告诉你的操作系统监听一个公开的IP 。</p>
<h3 id="调试模式"><a href="#调试模式" class="headerlink" title="调试模式"></a>调试模式</h3><p>开发程序不可能这么简单，需要不断的调试，所以<strong>Flask</strong>也为我们想好了，专门有个调试模式，这样不用重启服务器，代码有变动，会自动重启，并且出错提示信息也很强大，打开调试器的有两种方式：</p>
<ol>
<li>通过设置实例的属性<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.debug = True</span><br><span class="line">app.run()</span><br></pre></td></tr></table></figure></li>
<li>启动传参设置<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.run(debug=True)</span><br></pre></td></tr></table></figure>
**注意:**调试器很强大，可以执行任意代码，所以千万不要在项目上线之后打开调试模式。</li>
</ol>
<h3 id="路由route"><a href="#路由route" class="headerlink" title="路由route()"></a>路由route()</h3><p>路由装饰器用于将一个函数和一个<strong>URL</strong>绑定，例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def index():</span><br><span class="line">    return &#x27;Index Page&#x27;</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/hello&#x27;)</span><br><span class="line">def hello():</span><br><span class="line">    return &#x27;Hello World&#x27;</span><br></pre></td></tr></table></figure>
<p>这只是最简单，最基础的，实际开发中不可能都是这么简单的URL,大多数情况下URL里面有一部分是动态变化的，例如好多URL里面会带ID,表示网页的一个标号。</p>
<h4 id="变量规则"><a href="#变量规则" class="headerlink" title="变量规则"></a>变量规则</h4><p><variable_name>里面可以添加变量，<a href="converter:variable_name">converter:variable_name</a>可以为变量加一个转换器,目前只支持<code>int,float,path</code>最后一个为路径，接受<code>/</code>，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#x27;/user/&lt;username&gt;&#x27;)</span><br><span class="line">def show_user_profile(username):</span><br><span class="line">    # 通过获取URL的user_name作为函数的传入参数</span><br><span class="line">    return &#x27;User %s&#x27; % username</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/post/&lt;int:post_id&gt;&#x27;)</span><br><span class="line">def show_post(post_id):</span><br><span class="line">    # 传入post_id，并且必须是一个整数</span><br><span class="line">    return &#x27;Post %d&#x27; % post_id</span><br></pre></td></tr></table></figure>

<h4 id="唯一URL-重定向问题"><a href="#唯一URL-重定向问题" class="headerlink" title="唯一URL&#x2F;重定向问题"></a>唯一URL&#x2F;重定向问题</h4><p>看下面一个例子:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#x27;/projects/&#x27;)</span><br><span class="line">def projects():</span><br><span class="line">    return &#x27;The project page&#x27;</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/about&#x27;)</span><br><span class="line">def about():</span><br><span class="line">    return &#x27;The about page&#x27;</span><br></pre></td></tr></table></figure>
<p>注意一个尾部有<strong>斜杠</strong>，一个没有。看上去带<strong>斜杠</strong>的URL很像一个文件夹，当我们访问一个没有带<strong>斜杠</strong>的URL的时候，为自动加一个<strong>斜杠</strong>。但是反过来，如果访问第二个URL你在尾部带了一个<strong>斜杠</strong>，则会报错。可能你有些疑惑，为啥要这么做，答案也很简单：这样在访问一个不带<strong>斜杠</strong>的URL时，不管真正的URL是否带<strong>斜杠</strong>我们都可以继续访问URL,并且URL是唯一的。</p>
<h4 id="URL构建"><a href="#URL构建" class="headerlink" title="URL构建"></a>URL构建</h4><p>设想一下，你想先设定好页面的访问URL,你需要测试你写的函数能不能被你指定的URL访问到，直接构建这些URL就可以了。<code>url_for</code>它把函数名称作为第一个参数，其余参数对应URL中的变量。未知变量将添加到URL中作为查询参数。 例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, url_for</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def index(): pass</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/login&#x27;)</span><br><span class="line">def login(): pass</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/user/&lt;username&gt;&#x27;)</span><br><span class="line">def profile(username): pass</span><br><span class="line"></span><br><span class="line">with app.test_request_context():</span><br><span class="line">	print url_for(&#x27;index&#x27;)</span><br><span class="line">	print url_for(&#x27;login&#x27;)</span><br><span class="line">	print url_for(&#x27;login&#x27;, next=&#x27;/&#x27;)</span><br><span class="line">	print url_for(&#x27;profile&#x27;, username=&#x27;John Doe&#x27;)</span><br></pre></td></tr></table></figure>
<p>运行程序会输出以下内容:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/</span><br><span class="line">/login</span><br><span class="line">/login?next=/</span><br><span class="line">/user/John%20Doe</span><br></pre></td></tr></table></figure>
<p>这里用到了一个方法<code>test_request_context()</code>,这个会告诉<code>Flask</code>我们正在处理一个请求，虽然我们并没有真正的去请一个URL.</p>
<h4 id="HTTP方法"><a href="#HTTP方法" class="headerlink" title="HTTP方法"></a>HTTP方法</h4><p>访问一个URL有好几个方法，常见的就是get，post方法,缺省情况下一个路由只回应GET请求，也可以像下面这样手动指定：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#x27;/login&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span><br><span class="line">def login():</span><br><span class="line">    if request.method == &#x27;POST&#x27;:</span><br><span class="line">        do_the_login()</span><br><span class="line">    else:</span><br><span class="line">        show_the_login_form()</span><br></pre></td></tr></table></figure>

<h4 id="静态文件"><a href="#静态文件" class="headerlink" title="静态文件"></a>静态文件</h4><p>一般就是指css,js文件，如果工程里面要用到这些静态的库，可以在应用的根目录下新建<code>static</code>文件夹,设用选定的<code>static</code>端点就可以生成对应的URL：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for(&#x27;static&#x27;, filename=&#x27;style.css&#x27;)</span><br></pre></td></tr></table></figure>
<p>因此该文件对应的在文件系统中的路径应该是<code>static/style.css</code></p>
<h4 id="渲染模板"><a href="#渲染模板" class="headerlink" title="渲染模板"></a>渲染模板</h4><p>这是个很强大的功能，基本上目前的框架都得支持这个，毕竟原生的写HTML很慢，还要考虑各种转义，乱码等，Flask内置Jinja2模板引擎。使用<code>render_template()</code>来渲染模板,只需要把模板的名字和对应的一些参数传进去就行了，例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from flask import render_template</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/hello/&#x27;)</span><br><span class="line">@app.route(&#x27;/hello/&lt;name&gt;&#x27;)</span><br><span class="line">def hello(name=None):</span><br><span class="line">    return render_template(&#x27;hello.html&#x27;, name=name)</span><br></pre></td></tr></table></figure>
<p>Flask默认会在<code>templates</code>文件夹内寻找模板，如果你的应用是一个模块,则<code>templates</code>文件夹应该和应用在一个目录下,即:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/application.py</span><br><span class="line">/templates</span><br><span class="line">    /hello.html</span><br></pre></td></tr></table></figure>
<p>如果你的应用是一个包,则应该在包里面:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/application</span><br><span class="line">    /__init__.py</span><br><span class="line">    /templates</span><br><span class="line">        /hello.html</span><br></pre></td></tr></table></figure>
<p>这个就类似预JSP一类的东西，你也可以在模板内部访问**request, session, get_flashed_messages()<code>等，不过比JSP更加强大,因为模板可以实现继承，这样就能保持很多特定的元素重用，保持一致。 默认特殊的一些变量会被转义，例如HTML,如果信任某个变量，也可以使用</code>Markup&#96;类来把它标记为安全的,具体的等学到了再详细研究。</p>
<h3 id="操作请求数据"><a href="#操作请求数据" class="headerlink" title="操作请求数据"></a>操作请求数据</h3><p>一个Web应用其实就是服务器相应客户端发来的消息，Flask中由全局对象<code>request</code>来提供请求信息，如果你熟悉Python你就会知道，全局的对象大家都可以访问，其实也并不是通常意义上的全局变量，这个request只是特定环境下的本地对象的一个代理。</p>
<h4 id="请求对象"><a href="#请求对象" class="headerlink" title="请求对象"></a>请求对象</h4><p>首先必须从flask模块导入请求对象<code>from flask import request</code>,使用<code>method</code>属性可以操作当前请求的具体方法，<code>form</code>可以处理表单数据,例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#x27;/login&#x27;, methods=[&#x27;POST&#x27;, &#x27;GET&#x27;])</span><br><span class="line">def login():</span><br><span class="line">    error = None</span><br><span class="line">    if request.method == &#x27;POST&#x27;:</span><br><span class="line">        if valid_login(request.form[&#x27;username&#x27;],</span><br><span class="line">                       request.form[&#x27;password&#x27;]):</span><br><span class="line">            return log_the_user_in(request.form[&#x27;username&#x27;])</span><br><span class="line">        else:</span><br><span class="line">            error = &#x27;Invalid username/password&#x27;</span><br><span class="line">    # 如果请求访求是 GET 或验证未通过就会执行下面的代码</span><br><span class="line">    return render_template(&#x27;login.html&#x27;, error=error)</span><br></pre></td></tr></table></figure>
<p>如果form属性中不存在这个键值，会像普通集合那样抛出一个<code>KeyError</code>的异常。如果不捕获的话，就会显示一个<code>HTTP 400 Bad Request</code>错误页面，虽然你可以不用处理这个异常，但是显然不是很友好，所以推荐捕获异常，然会一个预定义好的错误页面.<br>如果要处理URL中的参数，可以使用<code>request.args.get(&#39;key&#39;, &#39;&#39;)</code>来获取.</p>
<h4 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h4><p>使用Flask实现文件上传很简单，需要在HTML表单中设置<code>enctype=&quot;multipart/form-data</code>属性即可，上传的文件被存储在内存或者文件系统临时位置，通过请求对象files属性可以访问上传文件,看下面的例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from flask import request</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/upload&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span><br><span class="line">def upload_file():</span><br><span class="line">    if request.method == &#x27;POST&#x27;:</span><br><span class="line">        f = request.files[&#x27;the_file&#x27;]</span><br><span class="line">        f.save(&#x27;/var/www/uploads/uploaded_file.txt&#x27;)</span><br></pre></td></tr></table></figure>
<p>要想知道文件上传之前在客户端系统的名字，可以使用<code>filename</code>属性，但是这个可以伪造，所以建议通过<code>Werkzeug</code>提供的<code>secure_filename()</code>函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from flask import request</span><br><span class="line">from werkzeug import secure_filename</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/upload&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span><br><span class="line">def upload_file():</span><br><span class="line">    if request.method == &#x27;POST&#x27;:</span><br><span class="line">        f = request.files[&#x27;the_file&#x27;]</span><br><span class="line">        f.save(&#x27;/var/www/uploads/&#x27; + secure_filename(f.filename))</span><br></pre></td></tr></table></figure>

<h4 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h4><p>对于Web应用来说，这个必不可少，要访问cookeis,可以使用<code>cookies</code>属性。通过请求对象的<code>set_cookies</code>方法设置<code>cookies</code>，请求对象的<code>cookies</code>包含了客户端的所有cookies字典，所以这很不安全，能使用会话就不要直接使用cookies.</p>
<ul>
<li>读cookies:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from flask import request</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def index():</span><br><span class="line">    username = request.cookies.get(&#x27;username&#x27;)</span><br><span class="line">    # 使用 cookies.get(key) 来代替 cookies[key] ，</span><br><span class="line">    # 以避免当 cookie 不存在时引发 KeyError 。</span><br></pre></td></tr></table></figure></li>
<li>存储cookies:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from flask import make_response</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def index():</span><br><span class="line">    resp = make_response(render_template(...))</span><br><span class="line">    resp.set_cookie(&#x27;username&#x27;, &#x27;the username&#x27;)</span><br><span class="line">    return resp</span><br></pre></td></tr></table></figure>
**注意:**cookies设置在响应对象上，通常只是视图函数返回字符串，Flask会把它们转化为响应对象,显示的转化可以使用<code>make_response()</code>函数,然后再修改对应的值.</li>
</ul>
<h3 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h3><p><code>redirect()</code>函数可以重定向,<code>abort()</code>可以更早的退出请求，返回错误码:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">from flask import abort, redirect, url_for</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def index():</span><br><span class="line">    return redirect(url_for(&#x27;login&#x27;))</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/login&#x27;)</span><br><span class="line">def login():</span><br><span class="line">    abort(401)</span><br><span class="line">    this_is_never_executed()</span><br></pre></td></tr></table></figure>
<p><code>401</code>表示一个无法访问的页面,缺省情况下每种错误代码都会对应显示一个黑白的出错页面。使用<code>errorhandler()</code>装饰器可以定制出错页面:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from flask import render_template</span><br><span class="line"></span><br><span class="line">@app.errorhandler(404)</span><br><span class="line">def page_not_found(error):</span><br><span class="line">    return render_template(&#x27;page_not_found.html&#x27;), 404</span><br></pre></td></tr></table></figure>

<h4 id="关于响应"><a href="#关于响应" class="headerlink" title="关于响应"></a>关于响应</h4><p>视图函数的返回值会自动转化为一个响应对象。如果你返回一个字符串，那么就会被转换为一个响应对象，其中包含这个字符串以及一些其他的必要信息，如果想在视图内部掌控响应对象的结果，可以使用一个<code>make_response()</code>函数进行强制转换，例如原始视图:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@app.errorhandler(404)</span><br><span class="line">def not_found(error):</span><br><span class="line">    return render_template(&#x27;error.html&#x27;), 404</span><br></pre></td></tr></table></figure>
<p>可以手动包装，修改某些特定的内容，例如头部信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@app.errorhandler(404)</span><br><span class="line">def not_found(error):</span><br><span class="line">    resp = make_response(render_template(&#x27;error.html&#x27;), 404)</span><br><span class="line">    resp.headers[&#x27;X-Something&#x27;] = &#x27;A value&#x27;</span><br><span class="line">    return resp</span><br></pre></td></tr></table></figure>

<h4 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h4><p>除了请求对象和响应对象之外，还有个<code>session</code>这个对象，这个主要是用来在不同请求之间存储信息的。你可以简单理解为用密钥签名加密的cookie,cookie都可以查看，但是如果没有密钥就无法修改。所以使用会话之前必须设置一个密钥：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, session, redirect, url_for, escape, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def index():</span><br><span class="line">    if &#x27;username&#x27; in session:</span><br><span class="line">        return &#x27;Logged in as %s&#x27; % escape(session[&#x27;username&#x27;])</span><br><span class="line">    return &#x27;You are not logged in&#x27;</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/login&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span><br><span class="line">def login():</span><br><span class="line">    if request.method == &#x27;POST&#x27;:</span><br><span class="line">        session[&#x27;username&#x27;] = request.form[&#x27;username&#x27;]</span><br><span class="line">        return redirect(url_for(&#x27;index&#x27;))</span><br><span class="line">    return &#x27;&#x27;&#x27;</span><br><span class="line">        &lt;form action=&quot;&quot; method=&quot;post&quot;&gt;</span><br><span class="line">            &lt;p&gt;&lt;input type=text name=username&gt;</span><br><span class="line">            &lt;p&gt;&lt;input type=submit value=Login&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/logout&#x27;)</span><br><span class="line">def logout():</span><br><span class="line">    # 如果会话中有用户名就删除它。</span><br><span class="line">    session.pop(&#x27;username&#x27;, None)</span><br><span class="line">    return redirect(url_for(&#x27;index&#x27;))</span><br><span class="line"></span><br><span class="line"># 设置密钥，复杂一点：</span><br><span class="line">app.secret_key = &#x27;A0Zr98j/3yX R~XHH!jmN]LWX/,?RT&#x27;</span><br></pre></td></tr></table></figure>
<p><code>escape()</code>可以用来转义，如果你使用模板就简单的多，不用管这些。<br>生成密钥要保证做够随机,例如根据操作系统来生成一个密钥:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">os.urandom(24)</span><br></pre></td></tr></table></figure>
<p>基于<code>cookies</code>的会话，Flask其实是把会话对象里面的值都放在了cookies里面，如果你访问的会话里没有对应的属性。</p>
<h4 id="消息闪现"><a href="#消息闪现" class="headerlink" title="消息闪现"></a>消息闪现</h4><p>啥意思？简单来说就是在你请求结束的时候记录一个消息，然后你下次再请求的时候可以使用，然后用完就销毁了，所以叫闪现。<code>flash()</code>用于闪现一个消息，<code>get_flashed_messages()</code>来操作一个消息，具体的不介绍了，这个用的不是很多，用到再研究。</p>
<h4 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h4><p>一个Web应用当然少不了日志，万一崩了，直接看日志定位问题，使用也很简单:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.logger.debug(&#x27;A value for debugging&#x27;)</span><br><span class="line">app.logger.warning(&#x27;A warning occurred (%d apples)&#x27;, 42)</span><br><span class="line">app.logger.error(&#x27;An error occurred&#x27;)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://sjq597.github.io/2016/04/24/Python-%E5%86%99csv%E6%96%87%E4%BB%B6Excel%E6%89%93%E5%BC%80%E4%B9%B1%E7%A0%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LittleQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LittleQ">
      <meta itemprop="description" content="数据开发工程师的成长历程">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LittleQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/04/24/Python-%E5%86%99csv%E6%96%87%E4%BB%B6Excel%E6%89%93%E5%BC%80%E4%B9%B1%E7%A0%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" class="post-title-link" itemprop="url">Python 写csv文件Excel打开乱码解决方案</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-04-24 18:37:32" itemprop="dateCreated datePublished" datetime="2016-04-24T18:37:32+08:00">2016-04-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-07 14:54:54" itemprop="dateModified" datetime="2023-10-07T14:54:54+08:00">2023-10-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Python笔记</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>398</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="需求背景"><a href="#需求背景" class="headerlink" title="需求背景"></a>需求背景</h3><p>最近为公司开发了一套邮件日报程序，邮件一般就是表格，图片，然后就是附件。附件一般都是默认写到txt文件里，但是PM希望邮件里的附件能直接用Excel这种软件打开，最开始想保存为Excel，但是一想Excel的文件体积会多出好多倍，csv文件默认也是使用Excel打开的，但是根本还是文本文件，体积小，保存也方便，于是最终决定使用csv模块来保存文件。</p>
<h3 id="Python写csv文件"><a href="#Python写csv文件" class="headerlink" title="Python写csv文件"></a>Python写csv文件</h3><p>Python提供了内置模块读写csv文件，这里我只用到了写，读这里就不做介绍了，也不难,主要是解决乱码问题。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">def save2csv(file_name=None, header=None, data=None):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    保存成CSV格式文件,方便Excel直接打开</span><br><span class="line">    :param file_name: 保存的文件名</span><br><span class="line">    :param header: 表头,每一列的名字</span><br><span class="line">    :param data: 具体填充数据</span><br><span class="line">    :return:</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    if file_name is None or isinstance(file_name, basestring) is False:</span><br><span class="line">        raise Exception(&#x27;保存CSV文件名不能为空,并且必须为字符串类型&#x27;)</span><br><span class="line"></span><br><span class="line">    if file_name.endswith(&#x27;.csv&#x27;) is False:</span><br><span class="line">        file_name += &#x27;.csv&#x27;</span><br><span class="line"></span><br><span class="line">    file_obj = open(file_name, &#x27;wb&#x27;)</span><br><span class="line">    file_obj.write(codecs.BOM_UTF8)     # 防止乱码</span><br><span class="line">    writer = csv.writer(file_obj)</span><br><span class="line"></span><br><span class="line">    if data is None or isinstance(data, (tuple, list)) is False:</span><br><span class="line">        raise Exception(&#x27;保存CSV文件失败,数据为空或者不是数据类型&#x27;)</span><br><span class="line"></span><br><span class="line">    if header is not None and isinstance(header, (tuple, list)) is True:</span><br><span class="line">        writer.writerow(header)</span><br><span class="line"></span><br><span class="line">    for row in data:</span><br><span class="line">        writer.writerow(row)</span><br></pre></td></tr></table></figure>
<p>**注意:**有三句话就是为了防止乱码的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file_obj = open(file_name, &#x27;wb&#x27;)</span><br><span class="line">file_obj.write(codecs.BOM_UTF8)     # 防止乱码</span><br><span class="line">writer = csv.writer(file_obj)</span><br></pre></td></tr></table></figure>
<p>在文件头部写入<code>codecs.BOM_UTF8</code>就能防止乱码了,文件都是utf-8编码格式的。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://sjq597.github.io/2016/04/24/Hive-group-by-distinct%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LittleQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LittleQ">
      <meta itemprop="description" content="数据开发工程师的成长历程">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LittleQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/04/24/Hive-group-by-distinct%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/" class="post-title-link" itemprop="url">Hive group by distinct性能调优</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-04-24 17:51:15" itemprop="dateCreated datePublished" datetime="2016-04-24T17:51:15+08:00">2016-04-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-07 14:54:54" itemprop="dateModified" datetime="2023-10-07T14:54:54+08:00">2023-10-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Hive%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Hive笔记</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>755</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Hive去重统计"><a href="#Hive去重统计" class="headerlink" title="Hive去重统计"></a>Hive去重统计</h3><p>相信使用Hive的人平时会经常用到去重统计之类的吧，但是好像平时很少关注这个去重的性能问题，但是当一个表的数据量非常大的时候，会发现一个简单的<code>count(distinct order_no)</code>这种语句跑的特别慢，和直接运行<code>count(order_no)</code>的时间差了很多，于是研究了一下。<br>**先说结论:**能使用<code>group by</code>代替<code>distinc</code>就不要使用<code>distinct</code>，例子：</p>
<h3 id="实际论证"><a href="#实际论证" class="headerlink" title="实际论证"></a>实际论证</h3><p>order_snap为订单的快照表 总记录条数763191489，即将近8亿条记录,总大小:108.877GB,存储的是公司所有的订单信息，表的字段大概有20个,其中订单号是没有重复的,所以在统计总共有多少订单号的时候去重不去重结果都一样，我们来看看:<br>统计所有的订单有多少条条数，一个<code>count</code>函数就可以搞定的sql性能如何。</p>
<ul>
<li>DISTINCT</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select count(distinct order_no) from order_snap;</span><br><span class="line">Stage-Stage-1: Map: 396  Reduce: 1   Cumulative CPU: 7915.67 sec   HDFS Read: 119072894175 HDFS Write: 10 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 0 days 2 hours 11 minutes 55 seconds 670 msec</span><br><span class="line">OK</span><br><span class="line">_c0</span><br><span class="line">763191489</span><br><span class="line">Time taken: 1818.864 seconds, Fetched: 1 row(s)</span><br></pre></td></tr></table></figure>

<ul>
<li>GROUP BY</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">select count(t.order_no) from (select order_no from order_snap group by order_no) t;</span><br><span class="line">Stage-Stage-1: Map: 396  Reduce: 457   Cumulative CPU: 10056.7 sec   HDFS Read: 119074266583 HDFS Write: 53469 SUCCESS</span><br><span class="line">Stage-Stage-2: Map: 177  Reduce: 1   Cumulative CPU: 280.22 sec   HDFS Read: 472596 HDFS Write: 10 SUCCESS</span><br><span class="line">Total MapReduce CPU Time Spent: 0 days 2 hours 52 minutes 16 seconds 920 msec</span><br><span class="line">OK</span><br><span class="line">_c0</span><br><span class="line">763191489</span><br><span class="line">Time taken: 244.192 seconds, Fetched: 1 row(s)</span><br></pre></td></tr></table></figure>

<p>**结论:**第二种写法的性能是第一种的<code>7.448499541</code>倍<br>注意到为什么会有这个差异，Hadoop其实就是处理大数据的，Hive并不怕数据有多大，怕的就是数据倾斜,我们看看两者的输出信息:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># distinct</span><br><span class="line">Stage-Stage-1: Map: 396  Reduce: 1   Cumulative CPU: 7915.67 sec   HDFS Read: 119072894175 HDFS Write: 10 SUCCESS</span><br><span class="line"># group by</span><br><span class="line">Stage-Stage-1: Map: 396  Reduce: 457   Cumulative CPU: 10056.7 sec   HDFS Read: 119074266583 HDFS Write: 53469 SUCCESS</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>发现猫腻了没有，使用distinct会将所有的order_no都shuffle到一个reducer里面，这就是我们所说的数据倾斜，都倾斜到一个reducer这样性能能不低么？再看第二个，直接按订单号分组，起了457个<code>reducer</code>，将数据分布到多台机器上执行，时间当然快了.<br>由于没有手动指定Reduce的个数，Hive会根据数据的大小动态的指定Reduce大小，你也可以手动指定</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; set mapred.reduce.tasks=100；</span><br></pre></td></tr></table></figure>
<p>类似这样,所以如果数据量特别大的情况下，尽量不要使用<code>distinct</code>吧。<br>但是如果你想在一条语句里看总记录条数以及去重之后的记录条数，那没有办法过滤，所以你有两个选择，要么使用两个sql语句分别跑，然后union all或者就使用普通的distinct。具体来说得看具体情况，直接使用distinct可读性好，数据量如果不大的话推荐使用，如果数据太大了，性能受到影响了，再考虑优化。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://sjq597.github.io/2016/04/24/SSH-%E5%85%8D%E5%AF%86%E7%A0%81%E7%99%BB%E9%99%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LittleQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LittleQ">
      <meta itemprop="description" content="数据开发工程师的成长历程">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LittleQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/04/24/SSH-%E5%85%8D%E5%AF%86%E7%A0%81%E7%99%BB%E9%99%86/" class="post-title-link" itemprop="url">SSH 免密码登陆</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-04-24 11:07:12" itemprop="dateCreated datePublished" datetime="2016-04-24T11:07:12+08:00">2016-04-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-07 14:54:54" itemprop="dateModified" datetime="2023-10-07T14:54:54+08:00">2023-10-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux%E4%BD%BF%E7%94%A8/" itemprop="url" rel="index"><span itemprop="name">Linux使用</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>461</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>开发工作中，经常需要使用ssh来登录服务器，密码一般都是机器生成的，特别难记，关键是机器多了这样也麻烦，所以配置一下ssh面密码登录，节省时间。</p>
<h3 id="系统说明"><a href="#系统说明" class="headerlink" title="系统说明"></a>系统说明</h3><p>本地机器：Ubuntu<br>服务器：CentOS</p>
<h3 id="大概流程"><a href="#大概流程" class="headerlink" title="大概流程"></a>大概流程</h3><p>需要服务器和本机都做一定的配置才能免密码登陆</p>
<h4 id="本地机器配置"><a href="#本地机器配置" class="headerlink" title="本地机器配置"></a>本地机器配置</h4><ol>
<li>通过<code>ssh-keygen</code>产生RSA公私密钥对</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-keygen`</span><br></pre></td></tr></table></figure>
<p>然后一路回车，不要输入任何密码和字符，最后在<code>~/.ssh/</code>文件夹中会生成两个文件<code>id_rsa</code>和<code>id_rsa.pub</code>两个文件，然后需要修改问年间权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ chmod 775 ~/.ssh</span><br></pre></td></tr></table></figure>
<p>将<code>id_rsa.pub</code>上传到服务器的<code>~/.ssh/</code>文件夹下，其实也不用上传，直接把这个文件的内容复制然后在服务器的对应文件夹下创建文件，然后写入也是一样的。<br>2. 在<code>~/.ssh/</code>文件夹里创建配置文件<code>config</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Host my_server // 服务器别名</span><br><span class="line">    HostName 192.168.1.120  // 服务器ip</span><br><span class="line">    User root   //登录用户名</span><br><span class="line">    Port 22     // ssh端口</span><br></pre></td></tr></table></figure>

<h4 id="服务器机器配置"><a href="#服务器机器配置" class="headerlink" title="服务器机器配置"></a>服务器机器配置</h4><ol>
<li>修改<code>/etc/ssh/sshd_config</code>文件,将下面几行前面的注释去掉<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RSAAuthentication yes</span><br><span class="line">PubkeyAuthentication yes</span><br><span class="line">AuthorizedKeysFile      %h/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>
如果已经注释掉了就不用配置则这里了，</li>
<li>在用户目录下创建<code>.ssh</code>文件夹，如果有就不用创建了，具体路径为<code>~/.ssh/</code><br>然后在<code>~/.ssh/</code>文件夹下面创建<code>authorized_keys</code>文件,并将之前上传到服务器上的<code>id_rsa.pub</code>文件里的内容拷贝到<code>authorized_keys</code>中,保存之后重启ssh服务</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cd ~/.ssh/</span><br><span class="line">$ sudo cat id_rsa.pub &gt; authorized_keys</span><br><span class="line">$ sudo chmod 644 authorized_keys</span><br><span class="line">$ sudo service sshd restart</span><br></pre></td></tr></table></figure>

<h4 id="本机测试"><a href="#本机测试" class="headerlink" title="本机测试"></a>本机测试</h4><p>通过终端连接服务器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh my_server</span><br></pre></td></tr></table></figure>
<p>**注意:**如果这一步出现<code>bad owers</code>等错误，记得要修改本机的文件权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ chmod 700 ~/.ssh</span><br><span class="line">$ chmod go+rwx ~/.ssh/*</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://sjq597.github.io/2016/04/23/%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80%E6%97%B6%E9%97%B4%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LittleQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LittleQ">
      <meta itemprop="description" content="数据开发工程师的成长历程">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | LittleQ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/04/23/%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80%E6%97%B6%E9%97%B4%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">脚本语言时间处理函数总结</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-04-23 13:55:58" itemprop="dateCreated datePublished" datetime="2016-04-23T13:55:58+08:00">2016-04-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-10-07 14:54:54" itemprop="dateModified" datetime="2023-10-07T14:54:54+08:00">2023-10-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Shell/" itemprop="url" rel="index"><span itemprop="name">Shell</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>737</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>平时做数据分析统计跑程序脚本需呀经常用到各种时间的转化和传入，日期的格式化，日期的相减，字符串时间互转。每次都是现查，比较浪费时间，这里把平时常用到的总结一下，因为涉及到好几个脚本语言的时间函数，我也记不住，干脆整理出一个查表更方便。主要涉及到Shell,Python,MySQL,Hive这几个脚本</p>
<h3 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h3><p>Shell感觉是最生涩的，最恶心的就是空格不能多也不能少，也没个IDE命令提示啥的，用的也最少，所以老容易忘</p>
<ul>
<li>常用的几种用法</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ date	以默认格式显示当前日期(Fri Nov 18 10:38:07 CST 2011)</span><br><span class="line">$ date +%Y%m%d             以yyyymmdd格式输出(20160423)</span><br><span class="line">$ date +&quot;%Y%m%d %A&quot;		以&quot;yyyymmdd 星期&quot;格式输出(20160423 Friday)  </span><br><span class="line">$ date -d &quot;1 day&quot; +%Y%m%d	显示一天后的日期(20160424)</span><br><span class="line">$ date -d &quot;3 day ago&quot; +%Y-%m-%d	以指定格式显示3天前的日期(2016-04-26)</span><br><span class="line">$ date -d &quot;1 month&quot; +%Y-%m-%d	以指定格式显示一个月后的日期</span><br><span class="line">$ date -d &quot;1 month&quot; +%s	以指定格式显示一个月后的日期的秒数，%S为当前的秒数(0～59)</span><br><span class="line">$ date -d &quot;1970-01-01 CST 1 second&quot; +%s	显示从1970-01-01 CST起1秒后的秒数</span><br></pre></td></tr></table></figure>
<ul>
<li>用<code>-d</code>这个参数可以产生各种时间组合</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ date -d &quot;-2 day 20160423&quot; +%Y%m%d</span><br><span class="line">20160421</span><br><span class="line">$ date -d &quot;+7 day 20160423&quot; +%Y%m%d</span><br><span class="line">20160430</span><br></pre></td></tr></table></figure>
<ul>
<li>日期循环</li>
</ul>
<p>这个场景还是很常用的，一般脚本都是默认跑当天或者前一天的数据，如果要一次重跑每一天的数据，可能就需要用到Shell日期循环：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">begin_date=&#x27;20160401&#x27;</span><br><span class="line">end_date=&#x27;20160423&#x27;</span><br><span class="line"></span><br><span class="line">while [ &quot;$begin_date&quot; != &quot;$end_date&quot; ]</span><br><span class="line">do</span><br><span class="line">	echo $begin_date</span><br><span class="line">	begin_date=`date -d &quot;1 day $begin_date&quot; +%Y%m%d`</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>**注意:**一定要用<code>&quot;&quot;</code>把条件扩起来，<code>!=</code>史比较字符串的。</p>
<h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><p>Python里用的比较多的就是两个包<code>datetime</code>,<code>time</code></p>
<ul>
<li>datetime</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">datetime.datetime.now().strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>)	<span class="comment"># 2016-04-23</span></span><br><span class="line"><span class="built_in">str</span>(datetime.datetime.now())[:<span class="number">10</span>]	<span class="comment"># 2016-04-23</span></span><br><span class="line">(datetime.datetime.now() + datetime.timedelta(days=-<span class="number">1</span>)).strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>)	<span class="comment"># 2016-04-22</span></span><br><span class="line">datetime.datetime.strptime(<span class="string">&#x27;2016-04-23&#x27;</span>, <span class="string">&#x27;%Y-%m-%d&#x27;</span>)	<span class="comment"># 将字符串格式为datetime对象</span></span><br><span class="line">(d1 - d2 ).days	<span class="comment"># d1,d2 为datetime对象，计算连个日期之间相差多少天</span></span><br><span class="line">(d1 - d2 ).seconds	<span class="comment"># d1,d2 为datetime对象，计算连个日期之间相差多少秒</span></span><br><span class="line">datetime.weekday()	<span class="comment"># 返回weekday，如果是星期一，返回0；如果是星期2，返回1，以此类推；</span></span><br><span class="line">datatime.isoweekday()	<span class="comment"># 返回weekday，如果是星期一，返回1；如果是星期2，返回2，以此类推；</span></span><br><span class="line">datetime.fromtimestamp(timestamp)	<span class="comment"># 根据给定的时间戮，返回一个datetime对象；</span></span><br></pre></td></tr></table></figure>

<ul>
<li>time<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time.strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;) # 格式化输出当前时间</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><p>主要是一些时间转换函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select unix_timestamp(&#x27;2016-01-01 10:10:10&#x27;);</span><br><span class="line">+---------------------------------------+</span><br><span class="line">| unix_timestamp(&#x27;2016-01-01 10:10:10&#x27;) |</span><br><span class="line">+---------------------------------------+</span><br><span class="line">|                            1451614210 |</span><br><span class="line">+---------------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select from_unixtime(unix_timestamp());</span><br><span class="line">+---------------------------------+</span><br><span class="line">| from_unixtime(unix_timestamp()) |</span><br><span class="line">+---------------------------------+</span><br><span class="line">| 2016-06-18 13:07:53             |</span><br><span class="line">+---------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Hive"><a href="#Hive" class="headerlink" title="Hive"></a>Hive</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">to_date(&#x27;2016-04-23&#x27;)	# 2016-04-23</span><br><span class="line">to_date(&#x27;2016-04-23 12:21:10&#x27;)	# 2016-04-23</span><br><span class="line">datediff(end_time, start_time)	# 返回日期相隔天数</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">LittleQ</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">124k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">7:31</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
